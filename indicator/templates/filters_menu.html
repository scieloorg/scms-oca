{# filters_menu.html - Filters Menu for Indicators #}
<style>
  .floating-actions {
    position: sticky;
    bottom: 0;
    height: 0;
    z-index: 3;
    pointer-events: none;
  }
  .floating-actions__inner {
    position: absolute;
    right: 0;
    bottom: 1rem;
    display: flex;
    justify-content: flex-end;
    width: 100%;
    pointer-events: auto;
  }
  .floating-actions__inner .btn {
    box-shadow: 0 4px 16px rgba(0,0,0,0.18), 0 1.5px 4px rgba(0,0,0,0.12);
  }
  @media (max-width: 576px) {
    .floating-actions__inner .btn {
      width: calc(100% - 32px);
    }
  }
</style>

<h4 style="margin: 0; padding-top: 0.5em; padding-bottom: 0.5em;">Filters</h4>
<div id="filters-menu" class="filters-menu">
  <form id="filters-form">
    <div id="filters-fields"></div>
    <div class="floating-actions mt-6">
      <div class="floating-actions__inner">
        <button type="button" id="reset-filters-btn" class="btn btn-secondary mr-2">Reset Filters</button>
        <button type="submit" class="btn btn-primary">Generate Graph</button>
      </div>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // References to loading spinner and filters container
  var menuLoading = document.getElementById('optionsLoading');

  // Load filter options and render fields dynamically
  var data_source = window.data_source;
  var country_unit = window.country_unit;

  var url = '/indicators/filters/?data_source=' + encodeURIComponent(data_source);
  if (country_unit && country_unit !== '') {
    url += '&country_unit=' + encodeURIComponent(country_unit);
  }

  fetch(url)
    .then(response => response.json())
    .then(data => {
      // Define which fields to show for each index
      var fieldsByIndex = {
        'openalex_works': [
          {key: 'source_index', label: 'Source Index'},
          {key: 'source_type', label: 'Source Type'},
          {key: 'publication_year', label: 'Publication Year'},
          {key: 'document_type', label: 'Document Type'},
          {key: 'document_language', label: 'Document Language'},
          {key: 'open_access', label: 'Open Access'},
          {key: 'access_type', label: 'Access Type'},
          {key: 'subject_area_level_0', label: 'Subject Area Level 0'},
          {key: 'subject_area_level_1', label: 'Subject Area Level 1'},
          {key: 'subject_area_level_2', label: 'Subject Area Level 2'},
          {key: 'region_world', label: 'Region - World (Author)'},
          {key: 'country', label: 'Country (Author)'}
        ],
        'scielo': [
          {key: 'journal', label: 'Journal'},
          {key: 'publication_year', label: 'Publication Year'},
          {key: 'document_type', label: 'Document Type'},
          {key: 'document_language', label: 'Document Language'},
          {key: 'access_type', label: 'Access Type'},
          {key: 'country', label: 'Country (Author)'}
        ],
        'social_production': [
          {key: 'publication_year', label: 'Publication Year'},
          {key: 'directory_type', label: 'Directory Type'},
          {key: 'action', label: 'Action'},
          {key: 'classification', label: 'Classification'},
          {key: 'institutions', label: 'Institutions'},
          {key: 'cities', label: 'Cities'},
          {key: 'states', label: 'States'},
          {key: 'practice', label: 'Practice'},
        ]
      };

      var fields = fieldsByIndex[data_source];
      var fieldsFieldsContainer = document.getElementById('filters-fields');
      fieldsFieldsContainer.innerHTML = '';

      fields.forEach(field => {
        if (data[field.key]) {
          var div = document.createElement('div');
          var label = document.createElement('label');
          if (data_source === "social_production") {
            label.setAttribute('for', field.key + ".enum");
          } else {
            label.setAttribute('for', field.key);
          }
          label.textContent = field.label;

          var select = document.createElement('select');
          if (data_source === "social_production") {
            select.id = field.key + ".enum"
          } else {
            select.id = field.key;
          }
          select.name = field.key;
          select.className = 'form-control';
          select.multiple = true;

          data[field.key].forEach(v => {
            var opt = document.createElement('option');
            if (field.key === 'open_access') {
              opt.value = v;
              opt.textContent = (v == 1) ? 'Yes' : 'No';
            } else {
              opt.value = v;
              opt.textContent = v;
            }
            if (field.key === 'publication_year') {
              // Pre-select all publication years >= 2014
              if (!isNaN(v) && Number(v) >= 2014) {
                opt.selected = true;
              }
            }
            select.appendChild(opt);
          });

          div.appendChild(label);
          div.appendChild(select);

          // Special handling: if data source is openalex_works and country is Brazil, do not show country filter
          if (!(data_source === "openalex_works" && country_unit && country_unit == "BR" && field.key === "country")) {
            fieldsFieldsContainer.appendChild(div);
          }
        }
      });

      // Remove 'citations' option from graph options when data source is 'scielo' or 'social_production'
      var graphOptionsContainer = document.getElementById('graph-options-menu');
      if (graphOptionsContainer) {
        if (data_source === 'scielo' || data_source === 'social_production') {
          const unitCitationOption = graphOptionsContainer.querySelector('option[value="unit_citation"]');
          if (unitCitationOption) {
            unitCitationOption.remove();
          }
        }
      }

      // Hide loading spinner and show filters
      if (optionsLoading) optionsLoading.style.display = 'none';

      // Fill breakdown variable options
      const breakdownSelect = document.getElementById('breakdown-variable-select');
      if (breakdownSelect) {
        breakdownSelect.innerHTML = '<option value="">Select a variable</option>';

        // Exclude publication_year, journal and document_languages from breakdown options
        var breakdownVars = fields.map(f => f.key).filter(key => (key !== 'publication_year'));

        breakdownVars.forEach(key => {
          if (data[key]) {
            let label = fields.find(f => f.key === key)?.label || key.replace(/_/g, ' ');
            if (data_source === "social_production" && key != "publication_year") {
              breakdownSelect.innerHTML += `<option value="${key}.enum">${label}</option>`;
            } else {
              breakdownSelect.innerHTML += `<option value="${key}">${label}</option>`;
            }
          }
        });
      }
    });

  document.getElementById('filters-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const filters = {};

    // Collect selected filters
    for (const [key, value] of formData.entries()) {
      if (filters[key]) {
        if (Array.isArray(filters[key])) {
          filters[key].push(value);
        } else {
          filters[key] = [filters[key], value];
        }
      } else {
        filters[key] = value;
      }
    }

    // Map study unit selection
    var studyUnitSelect = document.getElementById('study-unit-select');
    var study_unit = null;
    if (studyUnitSelect) {
      var val = studyUnitSelect.value;
      if (val === 'unit_citation') {
        study_unit = 'citation';
      } else if (val === 'unit_document') {
        study_unit = 'document';
      }
    }
    if (study_unit) {
      filters['study_unit'] = study_unit;
    }

    // Map breakdown variable selection
    var breakdownSelect = document.getElementById('breakdown-variable-select');
    var breakdown_variable = null;
    if (breakdownSelect) {
      breakdown_variable = breakdownSelect.value;
    }

    if (breakdown_variable) {
      filters['breakdown_variable'] = breakdown_variable;
    } else {
      // Remove breakdown_variable if not selected
      if ('breakdown_variable' in filters) {
        delete filters['breakdown_variable'];
      }
    }

    // Add data source to filters
    filters['data_source'] = data_source;

    // Add country unit to filters
    filters['country_unit'] = country_unit;

    // Update applied filters display
    if (typeof updateAppliedFiltersFromForm === 'function') {
      setTimeout(updateAppliedFiltersFromForm, 0);
    }

    // Fetch filtered data and update chart
    fetch('/indicators/indicators/', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(filters)
    })
    .then(response => response.json())
    .then(data => {
      if (typeof renderChart === 'function') {
        renderChart(data, study_unit);
      }
    });
  });

  // Reset form (filters
  document.getElementById('reset-filters-btn').addEventListener('click', function() {
    const form = document.getElementById('filters-form');
    if (!form) return;

    form.reset();
    form.querySelectorAll('select').forEach(function(sel) {
      Array.from(sel.options).forEach(function(opt) { opt.selected = false; });
    });

    // Re-select all publication years >= 2014
    let pubYearSelect;
    if (data_source === "social_production") {
      pubYearSelect = document.getElementById('publication_year.enum');
    } else {
      pubYearSelect = document.getElementById('publication_year');
    }
    if (pubYearSelect) {
      Array.from(pubYearSelect.options).forEach(function(opt) {
        opt.selected = !isNaN(opt.value) && Number(opt.value) >= 2014;
      });
    }

    if (typeof updateAppliedFiltersFromForm === 'function') {
      updateAppliedFiltersFromForm();
    }
  });

});
</script>

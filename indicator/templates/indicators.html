{% extends "base.html" %}
{% load humanize %}
{% load static %}
{% load i18n %}
{% load wagtailsettings_tags %}
{% load sizify %}
{% load partition %}
{% load humanize %}
{% load translate %}

{% get_settings use_default_site=True %}


{% block content %}
<section id="content" class="mt-3">
  <div class="container">
    <div class="row">
      <div class="col pl-0 pr-0">

        <div class="card mb-2 p-3" style="background:#F9F9F9;">
          <div class="page-title-content">
            <h1 class="mb-1">Indicators</h1>
            <span>Data panel of the OCABr Observatory</span>
          </div>
        </div>

      </div>
    </div>

    <div class="row card mb-2 p-3" style="background:#F9F9F9;">
      {% if data_source == "scielo" %}
        <h4 class="my-0">Scientific Production - SciELO Network</h4>
      {% elif data_source == "openalex_works" and country_unit == "BR" %}
        <h4 class="my-0">Scientific Production - Brazil</h4>
      {% elif data_source == "openalex_works" %}
        <h4 class="my-0">Scientific Production - World</h4>
      {% elif data_source == "social_production" %}
        <h4 class="my-0">Social Production</h4>
      {% endif %}
    </div>

    <div class="row mb-3" id="mainContent">
      <!-- Loading Overlay -->
      <div id="optionsLoading" style="display:none; position:absolute; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:10; justify-content:center; align-items:flex-start; text-align:center; margin-top: 1em;">
        <div class="spinner-border text-primary" role="status" style="width:3rem; height:3rem;">
          <span class="sr-only">Loading...</span>
        </div>
      </div>

      <!-- Menu -->
      <div class="col-lg-3 card mb-2 pt-2">
        <!-- Graph Options -->
        <div id="graph-options-container">
          {% include "graph_options_menu.html" %}
        </div>

        <!-- Filters -->
        <div id="filters-container">
          {% include "filters_menu.html" %}
        </div>
      </div>

      <!-- Graphs -->
      <div class="col-lg-9 mx-0 px-0">
        <!-- Applied Filters -->
        <div class="card mb-2 ml-2 p-3 d-none" id="applied-filters"></div>

        <!-- Main Graph -->
        <div class="card mb-2 ml-2 p-3 d-none" id="main-chart-div" style="height:75vh;">
          <div class="mx-auto" style="width:100%; height:100%;">
            <div id="main-chart" style="width:100%; height:100%;"></div>
          </div>
        </div>

        <!-- Inner Percentage Graph -->
        <div class="card mb-2 ml-2 p-3 d-none" id="inner-percentage-chart-div" style="height:75vh;">
          <div class="mx-auto" style="width:100%; height:100%;">
            <div id="inner-percentage-chart" style="width:100%; height:100%;"></div>
          </div>
        </div>

        <!-- Outer Percentage Graph -->
        <div class="card mb-2 ml-2 p-3 d-none" id="outer-percentage-chart-div" style="height:75vh;">
          <div class="mx-auto" style="width:100%; height:100%;">
            <div id="outer-percentage-chart" style="width:100%; height:100%;"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</section>
{% endblock %}

{% block inline_javascript %}
  <script src="{% static 'js/echarts/echarts.min.js' %}"></script>
  <script>
    window.data_source = "{{ data_source }}";
    window.country_unit = "{{ country_unit }}";

    // Function to render the main chart
    function renderChart(data, study_unit) {
      var chartContainer = document.getElementById('main-chart');
      // Set subtitle based on study_unit
      var studyUnitSubtitle = '';
      if (study_unit === 'citation') {
        studyUnitSubtitle = 'Study Unit: Citation';
      } else {
        studyUnitSubtitle = 'Study Unit: Document';
      }

      // Destroy previous chart instance if exists
      if (chartContainer && chartContainer._chartInstance) {
        chartContainer._chartInstance.dispose();
        chartContainer._chartInstance = null;
      }

      // Destroy inner percentage graph if breakdown variable is not set
      var innerPercentageChartContainer = document.getElementById('inner-percentage-chart');
      if (innerPercentageChartContainer && innerPercentageChartContainer._chartInstance && !data.breakdown_variable) {
        innerPercentageChartContainer._chartInstance.dispose();
        innerPercentageChartContainer._chartInstance = null;
      }

      // Destroy outer percentage graph if breakdown variable is not set
      var outerPercentageChartContainer = document.getElementById('outer-percentage-chart');
      if (outerPercentageChartContainer && outerPercentageChartContainer._chartInstance && !data.breakdown_variable) {
        outerPercentageChartContainer._chartInstance.dispose();
        outerPercentageChartContainer._chartInstance = null;
      }

      // Initialize new chart instance
      var chartObj = echarts.init(chartContainer);
      chartContainer._chartInstance = chartObj;
      var title, chartOpts;

      // Stacked bar chart
      if (data.breakdown_variable && data.series && data.years) {
        var breakdownLabel = document.querySelector('label[for="' + data.breakdown_variable + '"]');
        breakdownLabel = breakdownLabel ? breakdownLabel.textContent.trim() : data.breakdown_variable.replace(/_/g, ' ');
        title = 'Breakdown by ' + breakdownLabel;
        var seriesTotals = (data.series || []).map(function(s) {
          return {
            name: s.name,
            total: s.data.reduce(function(a, b) { return a + b; }, 0),
            data: s.data
          };
        });

        seriesTotals.sort(function(a, b) { return b.total - a.total; });
        var orderedKeys = seriesTotals.map(function(s) { return s.name; });
        var orderedSeries = seriesTotals.map(function(s) {
          return {
            name: s.name,
            type: 'bar',
            stack: 'total',
            data: s.data
          };
        });
        chartOpts = {
          title: { text: title, subtext: studyUnitSubtitle },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, confine: true, enterable: true, extraCssText: 'max-height:50vh; overflow-y:auto;' },
          legend: {
            type: 'scroll',
              data: orderedKeys,
            orient: 'horizontal',
            bottom: 0
          },
          grid: {
            top: 110,
            left: 0,
            right: 200,
            bottom: 40,
            containLabel: true
          },
          toolbox: {
              orient: "vertical",
              feature: {
          magicType: {
            type: ['line', 'bar', 'tiled'],
          },
                  dataView: {
                      show: true,
                      title: 'Data',
                      readOnly: true,
                      lang: ['', 'Close',]
                    },
                  saveAsImage: { show: true },
                  restore: { show: true },
                  dataZoom: {}
              }
          },
          xAxis: { type: 'category', data: data.years },
          yAxis: { type: 'value' },
            series: orderedSeries
        };
      // Simple bar chart for citations
      } else if (study_unit === "citation") {
        var xAxisData = data.years || [];
        var seriesData = data.total_citations_per_year || [];
        var seriesName = "Citations";
        title = "Number of Citations per Year";
        chartOpts = {
          title: { text: title, subtext: studyUnitSubtitle },
          tooltip: { confine: true, enterable: true, extraCssText: 'max-height:50vh; overflow-y:auto;' },
          grid: {
            top: 110,
            left: 0,
            right: 200,
            bottom: '10%',
            containLabel: true
          },
          toolbox: {
              orient: "vertical",
              feature: {
          magicType: {
            type: ['line', 'bar', 'tiled'],
          },
                  dataView: {
                      show: true,
                      title: 'Data',
                      readOnly: true,
                      lang: ['', 'Close',]
                    },
                  saveAsImage: { show: true },
                  restore: { show: true },
                  dataZoom: {}
              }
          },
          xAxis: { type: 'category', data: xAxisData },
          yAxis: { type: 'value' },
          series: [{
            name: seriesName,
            type: 'bar',
            data: seriesData,
          }]
        };
      // Simple bar chart for documents
      } else {
        var xAxisData = data.years || [];
        var seriesData = data.ndocs_per_year || [];
        var seriesName = "Documents";
        title = "Number of Documents per Year";
        chartOpts = {
          title: { text: title, subtext: studyUnitSubtitle },
          tooltip: { confine: true, enterable: true, extraCssText: 'max-height:50vh; overflow-y:auto;' },
          grid: {
            top: 110,
            left: 0,
            right: 200,
            bottom: '10%',
            containLabel: true
          },
          toolbox: {
              orient: "vertical",
              feature: {
          magicType: {
            type: ['line', 'bar', 'tiled'],
          },
                  dataView: {
                      show: true,
                      title: 'Data',
                      readOnly: true,
                      lang: ['', 'Close',]
                    },
                  saveAsImage: { show: true },
                  restore: { show: true },
                  dataZoom: {}
              }
          },
          xAxis: { type: 'category', data: xAxisData },
          yAxis: { type: 'value' },
          series: [{
            name: seriesName,
            type: 'bar',
            data: seriesData
          }]
        };
      }

      chartObj.setOption(chartOpts);
      window.addEventListener('resize', chartObj.resize);
    }

    // Function to render the outer percentage chart
    function renderOuterPercentageChart(data, study_unit) {
      var percentageChartContainer = document.getElementById('outer-percentage-chart');
      // Only applicable when there is a breakdown
      if (!data || !data.breakdown_variable || !Array.isArray(data.series) || !Array.isArray(data.years)) {
        if (percentageChartContainer && percentageChartContainer._chartInstance) {
            percentageChartContainer._chartInstance.dispose();
            percentageChartContainer._chartInstance = null;
        }
        return;
      }

      // Destroy previous chart instance if exists
      if (percentageChartContainer && percentageChartContainer._chartInstance) {
          percentageChartContainer._chartInstance.dispose();
          percentageChartContainer._chartInstance = null;
      }

      // Prepare baseline request (unfiltered, same data_source/country_unit, same study_unit and breakdown)
      var baselinePayload = {
        study_unit: study_unit === 'citation' ? 'citation' : 'document',
        breakdown_variable: data.breakdown_variable
      };

      // Fetch baseline data (no filters in body apart from study_unit/breakdown)
      fetch('/indicators/indicators/?data_source=' + encodeURIComponent(window.data_source) + '&country_unit=' + encodeURIComponent(window.country_unit), {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(baselinePayload)
      })
      .then(function(response) { return response.json(); })
      .then(function(baseline) {
        // Initialize chart instance
        var chartObj = echarts.init(percentageChartContainer);
        percentageChartContainer._chartInstance = chartObj;

        // Build maps for fast lookup and year alignment
        var filteredYears = data.years || [];
        var filteredSeries = data.series || [];
        var baselineYears = (baseline && baseline.years) ? baseline.years.map(String) : [];
        var baselineSeries = (baseline && baseline.series) ? baseline.series : [];

        // baselineMap[name][year] = value
        var baselineMap = {};
        (baselineSeries || []).forEach(function(s) {
          var name = String(s.name);
          baselineMap[name] = baselineMap[name] || {};
          (s.data || []).forEach(function(val, idx) {
            var y = baselineYears[idx];
            if (typeof y !== 'undefined') baselineMap[name][String(y)] = Number(val || 0);
          });
        });

        // Sort series by total filtered values (desc), keep names order accordingly
        var seriesTotals = (filteredSeries || []).map(function(s) {
          var total = (s.data || []).reduce(function(a, b) { return a + b; }, 0);
          return { name: String(s.name), total: total, data: s.data || [] };
        }).sort(function(a, b) { return b.total - a.total; });

        var orderedKeys = seriesTotals.map(function(s) { return s.name; });

        // Compose percentage series relative to baseline: (filtered / baseline) * 100
        var percentSeries = seriesTotals.map(function(s) {
          var baseByYear = baselineMap[s.name] || {};
          var pctData = (s.data || []).map(function(val, idx) {
            var year = String(filteredYears[idx]);
            var baseVal = Number(baseByYear[year] || 0);
            if (!baseVal) return 0;
            return ((Number(val) / baseVal) * 100).toFixed(2);
          });
          return {
            name: s.name,
            type: 'bar',
            stack: 'total',
            emphasis: { focus: 'series' },
            data: pctData
          };
        });

        var breakdownLabelEl = document.querySelector('label[for="' + data.breakdown_variable + '"]');
        var breakdownLabel = breakdownLabelEl ? breakdownLabelEl.textContent.trim() : data.breakdown_variable.replace(/_/g, ' ');
        var studyUnitSubtitle = (study_unit === 'citation') ? 'Study Unit: Citation' : 'Study Unit: Document';

        var chartOpts = {
          title: { text: 'Breakdown by ' + breakdownLabel + ' (% relative to unfiltered data)', subtext: studyUnitSubtitle },
          tooltip: {
            trigger: 'axis',
            axisPointer: { type: 'shadow' },
            confine: true,
            enterable: true,
            extraCssText: 'max-height:50vh; overflow-y:auto;',
            formatter: function(params) {
              var yearIdx = params && params.length ? params[0].dataIndex : 0;
              var yearLabel = String(filteredYears[yearIdx]);
              var lines = [];
              lines.push(params[0].axisValueLabel);
              params.forEach(function(p) {
                var name = p.seriesName;
                var baseVal = Number((baselineMap[name] || {})[yearLabel] || 0);
                var filt = (filteredSeries.find(function(s) { return String(s.name) === String(name); }) || {data:[]}).data[yearIdx] || 0;
                lines.push(p.marker + name + ': ' + p.value + '% (' + filt + ' / ' + baseVal + ')');
              });
              return lines.join('<br/>');
            }
          },
          legend: { type: 'scroll', data: orderedKeys, orient: 'horizontal', bottom: 0 },
          grid: { top: 110, left: 0, right: 200, bottom: 40, containLabel: true },
          toolbox: {
            orient: 'vertical',
            feature: {
              magicType: { type: ['bar', 'tield'] },
              dataView: { show: true, title: 'Data', readOnly: true, lang: ['', 'Close'] },
              saveAsImage: { show: true },
              restore: { show: true },
              dataZoom: {}
            }
          },
          xAxis: { type: 'category', data: filteredYears },
          yAxis: { type: 'value', axisLabel: { formatter: '{value} %' } },
          series: percentSeries
        };

        chartObj.setOption(chartOpts);
        window.addEventListener('resize', chartObj.resize);
      })
      .catch(function(err) {
        // If baseline fails, clear chart to avoid misleading results
        if (percentageChartContainer && percentageChartContainer._chartInstance) {
          percentageChartContainer._chartInstance.dispose();
          percentageChartContainer._chartInstance = null;
        }
        // Swallow error silently for now
      });
    }

    // Function to render the percentage chart
    function renderInnerPercentageChart(data, study_unit) {
      var percentageChartContainer = document.getElementById('inner-percentage-chart');

      // Set subtitle based on study_unit
      var studyUnitSubtitle = '';
      if (study_unit === 'citation') {
        studyUnitSubtitle = 'Study Unit: Citation';
      } else {
        studyUnitSubtitle = 'Study Unit: Document';
      }

      // Destroy previous inner percentage chart instance if exists
      if (percentageChartContainer && percentageChartContainer._chartInstance) {
        percentageChartContainer._chartInstance.dispose();
        percentageChartContainer._chartInstance = null;
      }
      
      // Initialize new chart instance
      var chartObj = echarts.init(percentageChartContainer);
      percentageChartContainer._chartInstance = chartObj;
      var title, chartOpts;

      // Percentage stacked bar chart
      if (data.breakdown_variable && data.series && data.years) {
        var breakdownLabel = document.querySelector('label[for="' + data.breakdown_variable + '"]');
        breakdownLabel = breakdownLabel ? breakdownLabel.textContent.trim() : data.breakdown_variable.replace(/_/g, ' ');
        title = 'Breakdown by ' + breakdownLabel + ' (% within filtered data)';
        var seriesTotals = (data.series || []).map(function(s) {
          var total = s.data.reduce(function(a, b) { return a + b; }, 0);
          return {
            name: s.name,
            total: total,
            data: s.data
          };
        });
        seriesTotals.sort(function(a, b) { return b.total - a.total; });
        var orderedKeys = seriesTotals.map(function(s) { return s.name; });
        var orderedSeries = seriesTotals.map(function(s) {
          return {
            name: s.name,
            type: 'bar',
            stack: 'total',
            emphasis: { focus: 'series' },
            label: {
              show: false,
              position: 'inside',
              formatter: function(params) {
                var total = 0;
                var yearIndex = params.dataIndex;
                (seriesTotals || []).forEach(function(s) { total += s.data[yearIndex]; });
                var percent = total ? ((params.value / total) * 100).toFixed(2) : 0;
                return percent + '%';
              }
            },
            data: s.data.map(function(value, index) {
              var total = 0;
              (seriesTotals || []).forEach(function(s) { total += s.data[index]; });
              var percent = total ? ((value / total) * 100).toFixed(2) : 0;
              return percent;
            })
          };
        });
        chartOpts = {
          title: { text: title, subtext: studyUnitSubtitle },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, confine: true, enterable: true, extraCssText: 'max-height:50vh; overflow-y:auto;', formatter: function (params) {
            var tar = params[0];
            var total = 0;
            params.forEach(function(p) { total += p.value; });
            var result = tar.axisValueLabel + '<br/>';
            params.forEach(function(p) {
              result += p.marker + p.seriesName + ': ' + p.value + '%<br/>';
            });
            return result;
          }},
          legend: {
            type: 'scroll',
              data: orderedKeys,
            orient: 'horizontal',
            bottom: 0
          },
          grid: {
            top: 110,
            left: 0,
            right: 200,
            bottom: 40,
            containLabel: true
          },
          toolbox: {
              orient: "vertical",
              feature: {
                  magicType: {
                      type: ['bar', 'tield'],
                  },
                  dataView: {
                      show: true,
                      title: 'Data',
                      readOnly: true,
                      lang: ['', 'Close',]
                    },
                  saveAsImage: { show: true },
                  restore: { show: true },
                  dataZoom: {}
              }
          },
          xAxis: { type: 'category', data: data.years },
          yAxis: { type: 'value', axisLabel: { formatter: '{value} %' } },
            series: orderedSeries
        };
      // Simple percentage bar chart for citations
      } else if (study_unit === "citation") {
        var xAxisData = data.years || [];
        var seriesData = data.total_citations_per_year || [];
        var seriesName = "Citations";
        title = "Percentage of Citations per Year";
        chartOpts = {
          title: { text: title, subtext: studyUnitSubtitle },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, confine: true, enterable: true, extraCssText: 'max-height:50vh; overflow-y:auto;', formatter: function (params) {
            var tar = params[0];
            var total = 0;
            params.forEach(function(p) { total += p.value; });
            var result = tar.axisValueLabel + '<br/>';
            params.forEach(function(p) {
              result += p.marker + p.seriesName + ': ' + p.value + '%<br/>';
            });
            return result;
          }},
          grid: {
            top: 110,
            left: 0,
            right: 200,
            bottom: '10%',
            containLabel: true
          },
          toolbox: {
              orient: "vertical",
              feature: {
                  magicType: {
                      type: ['bar', 'tield'],
                  },
                  dataView: {
                      show: true,
                      title: 'Data',
                      readOnly: true,
                      lang: ['', 'Close',]
                    },
                  saveAsImage: { show: true },
                  restore: { show: true },
                  dataZoom: {}
              }
          },
          xAxis: { type: 'category', data: xAxisData },
          yAxis: { type: 'value', axisLabel: { formatter: '{value} %' } },
          series: [{
            name: seriesName,
            type: 'bar',
            data: seriesData.map(function(value, index) {
              var total = 0;
              (data.total_citations_per_year || []).forEach(function(v) { total += v; });
              var percent = total ? ((value / total) * 100).toFixed(2) : 0;
              return percent;
            }),
          }]
        };
      // Simple percentage bar chart for documents
      } else {
        var xAxisData = data.years || [];
        var seriesData = data.ndocs_per_year || [];
        var seriesName = "Documents";
        title = "Percentage of Documents per Year";
        chartOpts = {
          title: { text: title, subtext: studyUnitSubtitle },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, confine: true, enterable: true, extraCssText: 'max-height:50vh; overflow-y:auto;', formatter: function (params) {
            var tar = params[0];
            var total = 0;
            params.forEach(function(p) { total += p.value; });
            var result = tar.axisValueLabel + '<br/>';
            params.forEach(function(p) {
              result += p.marker + p.seriesName + ': ' + p.value + '%<br/>';
            });
            return result;
          }},
          grid: {
            top: 110,
            left: 0,
            right: 200,
            bottom: '10%',
            containLabel: true
          },
          toolbox: {
              orient: "vertical",
              feature: {
                  magicType: {
                      type: ['bar', 'tield'],
                  },
                  dataView: {
                      show: true,
                      title: 'Data',
                      readOnly: true,
                      lang: ['', 'Close',]
                    },
                  saveAsImage: { show: true },
                  restore: { show: true },
                  dataZoom: {}
              }
          },
          xAxis: { type: 'category', data: xAxisData },
          yAxis: { type: 'value', axisLabel: { formatter: '{value} %' } },
          series: [{
            name: seriesName,
            type: 'bar',
            data: seriesData.map(function(value, index) {
              var total = 0;
              (data.ndocs_per_year || []).forEach(function(v) { total += v; });
              var percent = total ? ((value / total) * 100).toFixed(2) : 0;
              return percent;
            }),
          }]
        };
      }
      chartObj.setOption(chartOpts);
      window.addEventListener('resize', chartObj.resize);
    }

    // Helper function to convert years array to ranges
    function yearsToRanges(years) {
      if (!Array.isArray(years) || years.length === 0) return '';

      const uniq = Array.from(new Set(years.map(Number))).sort((a, b) => a - b);

      const ranges = [];
      let start = uniq[0], end = uniq[0];

      for (let i = 1; i < uniq.length; i++) {
        const y = uniq[i];
        if (y === end + 1) {
          end = y;
        } else {
          ranges.push(start === end ? `${start}` : `${start} to ${end}`);
          start = end = y;
        }
      }
      ranges.push(start === end ? `${start}` : `${start} to ${end}`);
      return ranges.join(', ');
    }

    // Function to update applied filters display
    function updateAppliedFiltersFromForm() {
      var container = document.getElementById('applied-filters');
      if (!container) return;

      var form = document.getElementById('filters-form');
      if (!form) return;

      var pieces = [];
      form.querySelectorAll('select').forEach(function(sel) {
        var selectedTexts = Array.from(sel.selectedOptions).map(function(opt) { return opt.textContent; });
        if (selectedTexts.length) {
          var labelEl = form.querySelector('label[for="' + sel.id + '"]');
          var label = labelEl ? labelEl.textContent.trim() : sel.name;
          if (label === "Publication Year") {
            var years = selectedTexts.map(function(text) { return parseInt(text); }).filter(function(y) { return !isNaN(y); });
            if (years.length) {
              selectedTexts = [yearsToRanges(years)];
            }
          }
          pieces.push(label + ': ' + selectedTexts.join(', '));
        }
      });

      if (pieces.length) {
        container.classList.remove('d-none');
        container.innerHTML = pieces.length ? '<strong>Applied Filters</strong>' + pieces.join(' | ') : '';
      } else {
        container.classList.add('d-none');
        container.innerHTML = '';
      }
    }

    // Intercept form submission to send correct params
    document.addEventListener('DOMContentLoaded', function() {
      var form = document.getElementById('filters-form');
      if (!form) return;

      form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Show loading overlay
        var loadingDiv = document.getElementById('optionsLoading');
        var contentDiv = document.getElementById('mainContent');
        if (loadingDiv) loadingDiv.style.display = 'flex';
        if (contentDiv) contentDiv.style.opacity = '0.3';

        var formData = new FormData(form);
        var filters = {};

        for (const [key, value] of formData.entries()) {
          if (filters[key]) {
            if (Array.isArray(filters[key])) {
              filters[key].push(value);
            } else {
              filters[key] = [filters[key], value];
            }
          } else {
            filters[key] = value;
          }
        }

        // Map study unit selection
        var studyUnitSelect = document.getElementById('study-unit-select');
        var study_unit = null;
        if (studyUnitSelect) {
          var val = studyUnitSelect.value;
          if (val === 'unit_citation') {
            study_unit = 'citation';
          } else if (val === 'unit_document') {
            study_unit = 'document';
          }
        }
        if (study_unit) {
          filters['study_unit'] = study_unit;
        }

        // Map breakdown variable selection
        var breakdownSelect = document.getElementById('breakdown-variable-select');
        var breakdown_variable = null;
        if (breakdownSelect) {
          breakdown_variable = breakdownSelect.value;
        }
        if (breakdown_variable) {
          filters['breakdown_variable'] = breakdown_variable;
        }

        // Fetch filtered data and update chart
        fetch('/indicators/indicators/?data_source=' + encodeURIComponent(window.data_source) + '&country_unit=' + encodeURIComponent(window.country_unit), {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(filters)
        })
        .then(response => response.json())
        .then(data => {
          if (typeof renderChart === 'function') {
            renderChart(data, study_unit);
            // Determine if there are filters other than publication_year
            var ignoredKeys = new Set(['publication_year','study_unit','breakdown_variable','data_source','country_unit']);
            var hasOtherFilters = Object.keys(filters).some(function(k){ return !ignoredKeys.has(k); });
            if (filters["breakdown_variable"]) {
              renderInnerPercentageChart(data, study_unit);
              if (hasOtherFilters) {
                renderOuterPercentageChart(data, study_unit);
              }
            }
            // Show/hide chart containers appropriately
            var applied = document.getElementById('applied-filters');
            var mainDiv = document.getElementById('main-chart-div');
            var innerDiv = document.getElementById('inner-percentage-chart-div');
            var outerDiv = document.getElementById('outer-percentage-chart-div');
            
            if (applied) applied.classList.remove('d-none');
            if (mainDiv) mainDiv.classList.remove('d-none');
            
            var hasBreakdown = !!filters['breakdown_variable'];
            if (innerDiv) innerDiv.classList.toggle('d-none', !hasBreakdown);
            if (outerDiv) outerDiv.classList.toggle('d-none', !(hasBreakdown && hasOtherFilters));
            
            // Ensure inner/outer charts are disposed when hidden
            if (!hasBreakdown) {
              var innerChart = document.getElementById('inner-percentage-chart');
              if (innerChart && innerChart._chartInstance) {
                innerChart._chartInstance.dispose();
                innerChart._chartInstance = null;
              }
            }
            if (!hasBreakdown || !hasOtherFilters) {
              var outerChart = document.getElementById('outer-percentage-chart');
              if (outerChart && outerChart._chartInstance) {
                outerChart._chartInstance.dispose();
                outerChart._chartInstance = null;
              }
            }
          }
        })
        .finally(() => {
          // Hide loading overlay
          var loadingDiv = document.getElementById('optionsLoading');
          if (loadingDiv) loadingDiv.style.display = 'none';
          if (contentDiv) contentDiv.style.opacity = '1';
        });
      });
    });
    window.updateAppliedFiltersFromForm = updateAppliedFiltersFromForm;
  </script>
{% endblock %}
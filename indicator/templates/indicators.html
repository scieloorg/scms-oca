{% extends "base.html" %}
{% load humanize %}
{% load static %}
{% load i18n %}
{% load wagtailsettings_tags %}
{% load sizify %}
{% load partition %}
{% load humanize %}
{% load translate %}

{% get_settings use_default_site=True %}


{% block content %}
<section id="content" class="mt-5">
  <div class="container">
    <div class="row">
      <div class="col pl-0">

        <div class="page-title-row mb-4" style="background:#F9F9F9;border-radius:4px;">
          <div class="page-title-content py-2 px-2">
            <h1 class="mb-1">Indicators</h1>
            <span>Data panel of the OCABr Observatory</span>
          </div>
        </div>

      </div>
    </div>

    <div class="row mb-3">

      <!-- Menu -->
      <div class="col-lg-3 card pt-2 filters-aside">
        
        <!-- Graph Options -->
        <div>
          {% include "graph_options_menu.html" %}
        </div>

        <!-- Filters -->
        <div>
          {% include "filters_menu.html" %}
        </div>

      </div>

      <!-- Content -->
      <div class="col-lg-9">

        <!-- Applied Filters -->
        <div class="px-4 row">
          <div class="col">
            <div id="applied-filters" class="alert alert-light border small d-none"></div>
          </div>
        </div>

        <!-- Main Graph -->
        <div class="mt-4 px-4 row">
          <div class="mb-2 mx-auto" style="max-width: 100%; min-height: 100%;">
            <div id="main-chart" style="position: relative; height:75vh; width:60vw"></div>
          </div>
        </div>

        <!-- Percentage Graph -->
        <div class="mt-4 px-4 row">
          <div class="mb-2 mx-auto" style="max-width: 100%; min-height: 100%;">
            <div id="percentage-chart" style="position: relative; height:75vh; width:60vw"></div>
          </div>
        </div>

      </div>

    </div>
  </div>
</section>
{% endblock %}

{% block inline_javascript %}
  <script src="{% static 'js/echarts/echarts.min.js' %}"></script>
  <script>
    function renderChart(data, unit_study) {
      var chartContainer = document.getElementById('main-chart');
      var chartObj = echarts.init(chartContainer);

      var seriesData, seriesName, title;
      if (unit_study === "citation") {
        seriesData = data.total_citations_per_year || [];
        seriesName = "Citations";
        title = "Number of Citations per Year";
      } else {
        seriesData = data.ndocs_per_year || [];
        seriesName = "Documents";
        title = "Number of Documents per Year";
      }

      var chartOpts = {
        title: { text: title },
        tooltip: {},
        grid: {
          top: 110,
          left: 0,
          right: 200,
          bottom: '10%',
          containLabel: true
        },
        toolbox: {
            orient: "vertical",
            feature: {
                magicType: {
                    type: ['line', 'bar', 'tield'],
                },
                dataView: {
                    show: true,
                    title: 'Data',
                    readOnly: true,
                    lang: ['', 'Close',]
                  },
                saveAsImage: { show: true },
                restore: { show: true },
                dataZoom: {}
            }
        },
        xAxis: { type: 'category', data: data.years || [] },
        yAxis: { type: 'value' },
        series: [{
          name: seriesName,
          type: 'bar',
          data: seriesData
        }]
      };

      chartObj.setOption(chartOpts);
      window.addEventListener('resize', chartObj.resize);
    }

    // Handle form submission
    function updateAppliedFiltersFromForm() {
      var container = document.getElementById('applied-filters');
      if (!container) return;
      var form = document.getElementById('filters-form');
      if (!form) return;

      // Study Unit
      var studyUnitSelect = document.getElementById('study-unit-select');
      var studyUnitText = '';
      if (studyUnitSelect) {
        var selected = studyUnitSelect.options[studyUnitSelect.selectedIndex];
        if (selected && selected.value) {
          studyUnitText = selected.textContent;
        }
      }

      // Metric
      var metricSelect = document.getElementById('metric-select');
      var metricText = '';
      if (metricSelect) {
        var selected = metricSelect.options[metricSelect.selectedIndex];
        if (selected && selected.value) {
          metricText = selected.textContent;
        }
      }

      var tags = [];
      if (studyUnitText) {
        tags.push('<span class="mr-1"><strong>Unit:</strong> ' + studyUnitText + '</span>');
      }
      if (metricText) {
        tags.push('<span class="mr-1"><strong>Metric:</strong> ' + metricText + '</span>');
      }

      var pieces = [];
      form.querySelectorAll('select').forEach(function(sel) {
        var selectedTexts = Array.from(sel.selectedOptions).map(function(opt) { return opt.textContent; });
        if (selectedTexts.length) {
          var labelEl = form.querySelector('label[for="' + sel.id + '"]');
          var label = labelEl ? labelEl.textContent.trim() : sel.name;
          pieces.push(label + ': ' + selectedTexts.join(', '));
        }
      });

      if (pieces.length || tags.length) {
        container.classList.remove('d-none');
        container.innerHTML = tags.join(' ') + (pieces.length ? '<strong>Applied Filters:</strong> ' + pieces.join(' | ') : '');
      } else {
        container.classList.add('d-none');
        container.innerHTML = '';
      }
    }

    window.updateAppliedFiltersFromForm = updateAppliedFiltersFromForm;
  </script>
{% endblock %}
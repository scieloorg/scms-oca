{% extends "base.html" %}
{% load humanize %}
{% load static %}
{% load i18n %}
{% load wagtailsettings_tags %}
{% load sizify %}
{% load partition %}
{% load humanize %}
{% load translate %}

{% get_settings use_default_site=True %}


{% block content %}
<section id="content" class="mt-3">
  <div class="container">
    <div class="row">
      <div class="col pl-0 pr-0">

        <div class="card mb-2 p-3" style="background:#F9F9F9;">
          <div class="page-title-content">
            <h1 class="mb-1">Indicators</h1>
            <span>Data panel of the OCABr Observatory</span>
          </div>
        </div>

      </div>
    </div>

    <div class="row card mb-2 p-3" style="background:#F9F9F9;">
      {% if data_source == "scielo" %}
        <h4 class="my-0">Scientific Production - SciELO Network</h4>
      {% elif data_source == "openalex_works" and country_unit == "BR" %}
        <h4 class="my-0">Scientific Production - Brazil</h4>
      {% elif data_source == "openalex_works" %}
        <h4 class="my-0">Scientific Production - World</h4>
      {% elif data_source == "social_production" %}
        <h4 class="my-0">Social Production</h4>
      {% endif %}
    </div>

    <div class="row mb-3" id="mainContent">
      <!-- Loading Overlay -->
      <div id="optionsLoading" style="display:none; position:absolute; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:10; justify-content:center; align-items:flex-start; text-align:center; margin-top: 1em;">
        <div class="spinner-border text-primary" role="status" style="width:3rem; height:3rem;">
          <span class="sr-only">Loading...</span>
        </div>
      </div>

      <!-- Menu -->
      <div class="col-lg-3 card pt-2 filters-aside">
        <!-- Graph Options -->
        <div id="graph-options-container">
          {% include "graph_options_menu.html" %}
        </div>

        <!-- Filters -->
        <div id="filters-container">
          {% include "filters_menu.html" %}
        </div>
      </div>

      <!-- Content -->
      <div class="col-lg-9">
        <!-- Applied Filters -->
        <div class="row m-2 p-2" id="applied-filters"></div>

        <!-- Main Graph -->
        <div class="row mt-2 mx-1">
          <div class="mb-2 mx-auto" style="max-width: 100%; min-height: 100%;">
            <div id="main-chart" style="position: relative; height:75vh; width:60vw"></div>
          </div>
        </div>

        <!-- Percentage Graph -->
        <div class="row mt-4 mx-1">
          <div class="mb-2 mx-auto" style="max-width: 100%; min-height: 100%;">
            <div id="percentage-chart" style="position: relative; height:75vh; width:60vw"></div>
          </div>
        </div>

      </div>

    </div>
  </div>
</section>
{% endblock %}

{% block inline_javascript %}
  <script src="{% static 'js/echarts/echarts.min.js' %}"></script>
  <script>
    window.data_source = "{{ data_source }}";
    window.country_unit = "{{ country_unit }}";

    // Function to render the main chart
    function renderChart(data, study_unit) {
      var chartContainer = document.getElementById('main-chart');

      // Destroy previous chart instance if exists
      if (chartContainer && chartContainer._chartInstance) {
        chartContainer._chartInstance.dispose();
        chartContainer._chartInstance = null;
      }

      // Destroy percentage graph if breakdown variable is not set
      var percentageChartContainer = document.getElementById('percentage-chart');
      if (percentageChartContainer && percentageChartContainer._chartInstance && !data.breakdown_variable) {
        percentageChartContainer._chartInstance.dispose();
        percentageChartContainer._chartInstance = null;
      }

      // Initialize new chart instance
      var chartObj = echarts.init(chartContainer);
      chartContainer._chartInstance = chartObj;
      var title, chartOpts;

      // Stacked bar chart
      if (data.breakdown_variable && data.series && data.years) {
        var breakdownLabel = document.querySelector('label[for="' + data.breakdown_variable + '"]');
        breakdownLabel = breakdownLabel ? breakdownLabel.textContent.trim() : data.breakdown_variable.replace(/_/g, ' ');
        title = 'Breakdown by ' + breakdownLabel;
        var seriesTotals = (data.series || []).map(function(s) {
          return {
            name: s.name,
            total: s.data.reduce(function(a, b) { return a + b; }, 0),
            data: s.data
          };
        });

        seriesTotals.sort(function(a, b) { return b.total - a.total; });
        var orderedKeys = seriesTotals.map(function(s) { return s.name; });
        var orderedSeries = seriesTotals.map(function(s) {
          return {
            name: s.name,
            type: 'bar',
            stack: 'total',
            data: s.data
          };
        });
        chartOpts = {
          title: { text: title },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' } },
          legend: {
            type: 'scroll',
              data: orderedKeys,
            orient: 'horizontal',
            bottom: 0
          },
          grid: {
            top: 110,
            left: 0,
            right: 200,
            bottom: 40,
            containLabel: true
          },
          toolbox: {
              orient: "vertical",
              feature: {
                  magicType: {
                      type: ['line', 'bar', 'tield'],
                  },
                  dataView: {
                      show: true,
                      title: 'Data',
                      readOnly: true,
                      lang: ['', 'Close',]
                    },
                  saveAsImage: { show: true },
                  restore: { show: true },
                  dataZoom: {}
              }
          },
          xAxis: { type: 'category', data: data.years },
          yAxis: { type: 'value' },
            series: orderedSeries
        };
      // Simple bar chart for citations
      } else if (study_unit === "citation") {
        var xAxisData = data.years || [];
        var seriesData = data.total_citations_per_year || [];
        var seriesName = "Citations";
        title = "Number of Citations per Year";
        chartOpts = {
          title: { text: title },
          tooltip: {},
          grid: {
            top: 110,
            left: 0,
            right: 200,
            bottom: '10%',
            containLabel: true
          },
          toolbox: {
              orient: "vertical",
              feature: {
                  magicType: {
                      type: ['line', 'bar', 'tield'],
                  },
                  dataView: {
                      show: true,
                      title: 'Data',
                      readOnly: true,
                      lang: ['', 'Close',]
                    },
                  saveAsImage: { show: true },
                  restore: { show: true },
                  dataZoom: {}
              }
          },
          xAxis: { type: 'category', data: xAxisData },
          yAxis: { type: 'value' },
          series: [{
            name: seriesName,
            type: 'bar',
            data: seriesData,
          }]
        };
      // Simple bar chart for documents
      } else {
        var xAxisData = data.years || [];
        var seriesData = data.ndocs_per_year || [];
        var seriesName = "Documents";
        title = "Number of Documents per Year";
        chartOpts = {
          title: { text: title },
          tooltip: {},
          grid: {
            top: 110,
            left: 0,
            right: 200,
            bottom: '10%',
            containLabel: true
          },
          toolbox: {
              orient: "vertical",
              feature: {
                  magicType: {
                      type: ['line', 'bar', 'tield'],
                  },
                  dataView: {
                      show: true,
                      title: 'Data',
                      readOnly: true,
                      lang: ['', 'Close',]
                    },
                  saveAsImage: { show: true },
                  restore: { show: true },
                  dataZoom: {}
              }
          },
          xAxis: { type: 'category', data: xAxisData },
          yAxis: { type: 'value' },
          series: [{
            name: seriesName,
            type: 'bar',
            data: seriesData
          }]
        };
      }

      chartObj.setOption(chartOpts);
      window.addEventListener('resize', chartObj.resize);
    }

    // Function to render the percentage chart
    function renderPercentageChart(data, study_unit) {
      var chartContainer = document.getElementById('percentage-chart');

      // Destroy previous chart instance if exists
      if (chartContainer && chartContainer._chartInstance) {
        chartContainer._chartInstance.dispose();
        chartContainer._chartInstance = null;
      }
      
      // Initialize new chart instance
      var chartObj = echarts.init(chartContainer);
      chartContainer._chartInstance = chartObj;
      var title, chartOpts;

      // Percentage stacked bar chart
      if (data.breakdown_variable && data.series && data.years) {
        var breakdownLabel = document.querySelector('label[for="' + data.breakdown_variable + '"]');
        breakdownLabel = breakdownLabel ? breakdownLabel.textContent.trim() : data.breakdown_variable.replace(/_/g, ' ');
        title = 'Percentage Breakdown by ' + breakdownLabel;
        var seriesTotals = (data.series || []).map(function(s) {
          var total = s.data.reduce(function(a, b) { return a + b; }, 0);
          return {
            name: s.name,
            total: total,
            data: s.data
          };
        });
        seriesTotals.sort(function(a, b) { return b.total - a.total; });
        var orderedKeys = seriesTotals.map(function(s) { return s.name; });
        var orderedSeries = seriesTotals.map(function(s) {
          return {
            name: s.name,
            type: 'bar',
            stack: 'total',
            emphasis: { focus: 'series' },
            label: {
              show: false,
              position: 'inside',
              formatter: function(params) {
                var total = 0;
                var yearIndex = params.dataIndex;
                (seriesTotals || []).forEach(function(s) { total += s.data[yearIndex]; });
                var percent = total ? ((params.value / total) * 100).toFixed(2) : 0;
                return percent + '%';
              }
            },
            data: s.data.map(function(value, index) {
              var total = 0;
              (seriesTotals || []).forEach(function(s) { total += s.data[index]; });
              var percent = total ? ((value / total) * 100).toFixed(2) : 0;
              return percent;
            })
          };
        });
        chartOpts = {
          title: { text: title },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, formatter: function (params) {
            var tar = params[0];
            var total = 0;
            params.forEach(function(p) { total += p.value; });
            var result = tar.axisValueLabel + '<br/>';
            params.forEach(function(p) {
              result += p.marker + p.seriesName + ': ' + p.value + '%<br/>';
            });
            return result;
          }},
          legend: {
            type: 'scroll',
              data: orderedKeys,
            orient: 'horizontal',
            bottom: 0
          },
          grid: {
            top: 110,
            left: 0,
            right: 200,
            bottom: 40,
            containLabel: true
          },
          toolbox: {
              orient: "vertical",
              feature: {
                  magicType: {
                      type: ['bar', 'tield'],
                  },
                  dataView: {
                      show: true,
                      title: 'Data',
                      readOnly: true,
                      lang: ['', 'Close',]
                    },
                  saveAsImage: { show: true },
                  restore: { show: true },
                  dataZoom: {}
              }
          },
          xAxis: { type: 'category', data: data.years },
          yAxis: { type: 'value', axisLabel: { formatter: '{value} %' } },
            series: orderedSeries
        };
      // Simple percentage bar chart for citations
      } else if (study_unit === "citation") {
        var xAxisData = data.years || [];
        var seriesData = data.total_citations_per_year || [];
        var seriesName = "Citations";
        title = "Percentage of Citations per Year";
        chartOpts = {
          title: { text: title },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, formatter: function (params) {
            var tar = params[0];
            var total = 0;
            params.forEach(function(p) { total += p.value; });
            var result = tar.axisValueLabel + '<br/>';
            params.forEach(function(p) {
              result += p.marker + p.seriesName + ': ' + p.value + '%<br/>';
            });
            return result;
          }},
          grid: {
            top: 110,
            left: 0,
            right: 200,
            bottom: '10%',
            containLabel: true
          },
          toolbox: {
              orient: "vertical",
              feature: {
                  magicType: {
                      type: ['bar', 'tield'],
                  },
                  dataView: {
                      show: true,
                      title: 'Data',
                      readOnly: true,
                      lang: ['', 'Close',]
                    },
                  saveAsImage: { show: true },
                  restore: { show: true },
                  dataZoom: {}
              }
          },
          xAxis: { type: 'category', data: xAxisData },
          yAxis: { type: 'value', axisLabel: { formatter: '{value} %' } },
          series: [{
            name: seriesName,
            type: 'bar',
            data: seriesData.map(function(value, index) {
              var total = 0;
              (data.total_citations_per_year || []).forEach(function(v) { total += v; });
              var percent = total ? ((value / total) * 100).toFixed(2) : 0;
              return percent;
            }),
          }]
        };
      // Simple percentage bar chart for documents
      } else {
        var xAxisData = data.years || [];
        var seriesData = data.ndocs_per_year || [];
        var seriesName = "Documents";
        title = "Percentage of Documents per Year";
        chartOpts = {
          title: { text: title },
          tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, formatter: function (params) {
            var tar = params[0];
            var total = 0;
            params.forEach(function(p) { total += p.value; });
            var result = tar.axisValueLabel + '<br/>';
            params.forEach(function(p) {
              result += p.marker + p.seriesName + ': ' + p.value + '%<br/>';
            });
            return result;
          }},
          grid: {
            top: 110,
            left: 0,
            right: 200,
            bottom: '10%',
            containLabel: true
          },
          toolbox: {
              orient: "vertical",
              feature: {
                  magicType: {
                      type: ['bar', 'tield'],
                  },
                  dataView: {
                      show: true,
                      title: 'Data',
                      readOnly: true,
                      lang: ['', 'Close',]
                    },
                  saveAsImage: { show: true },
                  restore: { show: true },
                  dataZoom: {}
              }
          },
          xAxis: { type: 'category', data: xAxisData },
          yAxis: { type: 'value', axisLabel: { formatter: '{value} %' } },
          series: [{
            name: seriesName,
            type: 'bar',
            data: seriesData.map(function(value, index) {
              var total = 0;
              (data.ndocs_per_year || []).forEach(function(v) { total += v; });
              var percent = total ? ((value / total) * 100).toFixed(2) : 0;
              return percent;
            }),
          }]
        };
      }
      chartObj.setOption(chartOpts);
      window.addEventListener('resize', chartObj.resize);
    }

    // Function to update applied filters display
    function updateAppliedFiltersFromForm() {
      var container = document.getElementById('applied-filters');
      if (!container) return;

      var form = document.getElementById('filters-form');
      if (!form) return;

      // Study Unit
      var studyUnitSelect = document.getElementById('study-unit-select');
      var studyUnitText = '';
      if (studyUnitSelect) {
        var selected = studyUnitSelect.options[studyUnitSelect.selectedIndex];
        if (selected && selected.value) {
          studyUnitText = selected.textContent;
        }
      }

      var tags = [];
      if (studyUnitText) {
        tags.push('<span class="mr-2"><strong>Study Unit:</strong> ' + studyUnitText + '</span>');
      }

      var pieces = [];
      form.querySelectorAll('select').forEach(function(sel) {
        var selectedTexts = Array.from(sel.selectedOptions).map(function(opt) { return opt.textContent; });
        if (selectedTexts.length) {
          var labelEl = form.querySelector('label[for="' + sel.id + '"]');
          var label = labelEl ? labelEl.textContent.trim() : sel.name;
          pieces.push(label + ': ' + selectedTexts.join(', '));
        }
      });

      if (pieces.length || tags.length) {
        container.classList.remove('d-none');
        container.innerHTML = tags.join(' ') + (pieces.length ? '<strong>Applied Filters: </strong> ' + pieces.join(' | ') : '');
      } else {
        container.classList.add('d-none');
        container.innerHTML = '';
      }
    }

    // Intercept form submission to send correct params
    document.addEventListener('DOMContentLoaded', function() {
      var form = document.getElementById('filters-form');
      if (!form) return;

      form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Show loading overlay
        var loadingDiv = document.getElementById('optionsLoading');
        var contentDiv = document.getElementById('mainContent');
        if (loadingDiv) loadingDiv.style.display = 'flex';
        if (contentDiv) contentDiv.style.opacity = '0.3';

        var formData = new FormData(form);
        var filters = {};

        for (const [key, value] of formData.entries()) {
          if (filters[key]) {
            if (Array.isArray(filters[key])) {
              filters[key].push(value);
            } else {
              filters[key] = [filters[key], value];
            }
          } else {
            filters[key] = value;
          }
        }

        // Map study unit selection
        var studyUnitSelect = document.getElementById('study-unit-select');
        var study_unit = null;
        if (studyUnitSelect) {
          var val = studyUnitSelect.value;
          if (val === 'unit_citation') {
            study_unit = 'citation';
          } else if (val === 'unit_document') {
            study_unit = 'document';
          }
        }
        if (study_unit) {
          filters['study_unit'] = study_unit;
        }

        // Map breakdown variable selection
        var breakdownSelect = document.getElementById('breakdown-variable-select');
        var breakdown_variable = null;
        if (breakdownSelect) {
          breakdown_variable = breakdownSelect.value;
        }
        if (breakdown_variable) {
          filters['breakdown_variable'] = breakdown_variable;
        }

        // Fetch filtered data and update chart
        fetch('/indicators/indicators/?data_source=' + encodeURIComponent(window.data_source) + '&country_unit=' + encodeURIComponent(window.country_unit), {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(filters)
        })
        .then(response => response.json())
        .then(data => {
          if (typeof renderChart === 'function') {
            renderChart(data, study_unit);
            if (filters["breakdown_variable"]) {
              renderPercentageChart(data, study_unit);
            }
          }
        })
        .finally(() => {
          // Hide loading overlay
          if (optionsLoading) optionsLoading.style.display = 'none';
          if (contentDiv) contentDiv.style.opacity = '1';
        });
      });

    // Initial chart rendering
    updateAppliedFiltersFromForm();
    });

    window.updateAppliedFiltersFromForm = updateAppliedFiltersFromForm;
  </script>
{% endblock %}
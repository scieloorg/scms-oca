{% load i18n static %}

<h4 class="my-2 pt-1">{% trans "Ranking Configuration" %}</h4>

<div class="filter-group-card filter-group-card--muted filter-group-card--collapsible mb-3">
    <div class="filter-group-card__title">{% trans "Ranking" %}</div>

    <div class="form-group mb-3">
        <label class="form-label" for="publication_year">{% trans "Publication Year" %}</label>
        <input
            id="publication_year"
            class="form-control"
            name="publication_year"
            aria-label="{% trans 'Publication Year' %}"
            type="text"
            value="{{ applied_filters.publication_year|default:default_publication_year|default:'' }}"
            placeholder="{% trans 'Publication Year' %}"
        />
    </div>

    <div class="form-group mb-3">
        <label class="form-label" for="ranking_metric">{% trans "Ranking metric" %}</label>
        <select id="ranking_metric" class="form-control" name="ranking_metric" aria-label="{% trans 'Ranking metric' %}">
            <optgroup label="{% trans 'Impact' %}">
                <option {% if applied_filters.ranking_metric == "journal_impact_normalized" %}selected{% endif %} value="journal_impact_normalized">{% trans "Normalized Impact" %}</option>
                <option {% if applied_filters.ranking_metric == "journal_impact_normalized_window_2y" %}selected{% endif %} value="journal_impact_normalized_window_2y">{% trans "Normalized Impact (2 years)" %}</option>
                <option {% if applied_filters.ranking_metric == "journal_impact_normalized_window_3y" or not applied_filters.ranking_metric %}selected{% endif %} value="journal_impact_normalized_window_3y">{% trans "Normalized Impact (3 years)" %}</option>
                <option {% if applied_filters.ranking_metric == "journal_impact_normalized_window_5y" %}selected{% endif %} value="journal_impact_normalized_window_5y">{% trans "Normalized Impact (5 years)" %}</option>
            </optgroup>
            <optgroup label="{% trans 'Citations' %}">
                <option {% if applied_filters.ranking_metric == "journal_citations_total" %}selected{% endif %} value="journal_citations_total">{% trans "Total Citations" %}</option>
                <option {% if applied_filters.ranking_metric == "journal_citations_mean" %}selected{% endif %} value="journal_citations_mean">{% trans "Mean Citations" %}</option>
                <option {% if applied_filters.ranking_metric == "journal_citations_mean_window_2y" %}selected{% endif %} value="journal_citations_mean_window_2y">{% trans "Mean Citations (2 years)" %}</option>
                <option {% if applied_filters.ranking_metric == "journal_citations_mean_window_3y" %}selected{% endif %} value="journal_citations_mean_window_3y">{% trans "Mean Citations (3 years)" %}</option>
                <option {% if applied_filters.ranking_metric == "journal_citations_mean_window_5y" %}selected{% endif %} value="journal_citations_mean_window_5y">{% trans "Mean Citations (5 years)" %}</option>
            </optgroup>
            <optgroup label="{% trans 'Publications' %}">
                <option {% if applied_filters.ranking_metric == "journal_publications_count" %}selected{% endif %} value="journal_publications_count">{% trans "Publication Count" %}</option>
                <option {% if applied_filters.ranking_metric == "top_1pct_all_time_publications_share_pct" %}selected{% endif %} value="top_1pct_all_time_publications_share_pct">{% trans "Top 1% Publications Share" %}</option>
                <option {% if applied_filters.ranking_metric == "top_5pct_all_time_publications_share_pct" %}selected{% endif %} value="top_5pct_all_time_publications_share_pct">{% trans "Top 5% Publications Share" %}</option>
                <option {% if applied_filters.ranking_metric == "top_10pct_all_time_publications_share_pct" %}selected{% endif %} value="top_10pct_all_time_publications_share_pct">{% trans "Top 10% Publications Share" %}</option>
                <option {% if applied_filters.ranking_metric == "top_50pct_all_time_publications_share_pct" %}selected{% endif %} value="top_50pct_all_time_publications_share_pct">{% trans "Top 50% Publications Share" %}</option>
            </optgroup>
        </select>
    </div>

    <div class="form-group mb-0">
        <label class="form-label" for="limit">{% trans "Number of results" %}</label>
        <select id="limit" class="form-control" name="limit" aria-label="{% trans 'Number of results' %}">
            <option value="10" {% if applied_filters.limit == "10" %}selected{% endif %}>10</option>
            <option value="25" {% if applied_filters.limit == "25" %}selected{% endif %}>25</option>
            <option value="50" {% if applied_filters.limit == "50" %}selected{% endif %}>50</option>
            <option value="100" {% if applied_filters.limit == "100" or not applied_filters.limit %}selected{% endif %}>100</option>
            <option value="200" {% if applied_filters.limit == "200" %}selected{% endif %}>200</option>
            <option value="500" {% if applied_filters.limit == "500" %}selected{% endif %}>500</option>
            <option value="1000" {% if applied_filters.limit == "1000" %}selected{% endif %}>1000</option>
        </select>
    </div>
</div>

<h4 class="my-2 pt-1">{% trans "Filters" %}</h4>

<div class="filter-group-card filter-group-card--muted filter-group-card--collapsible">
    <div class="filter-group-card__title">{% trans "Journal Identity" %}</div>

    <div class="form-group mb-3">
        <label class="form-label" for="journal_title">{% trans "Journal" %}</label>
        <select id="journal_title" class="form-control" name="journal_title" aria-label="{% trans 'Journal' %}"></select>
    </div>

    <div class="form-group mb-3">
        <label class="form-label" for="journal_issn">{% trans "ISSN" %}</label>
        <select id="journal_issn" class="form-control" name="journal_issn" aria-label="{% trans 'ISSN' %}"></select>
    </div>

    <div class="form-group mb-3">
        <label class="form-label" for="publisher_name">{% trans "Publisher" %}</label>
        <select id="publisher_name" class="form-control" name="publisher_name" aria-label="{% trans 'Publisher' %}"></select>
    </div>

    <div class="form-group mb-3">
        <label class="form-label" for="country">{% trans "Country" %}</label>
        <select id="country" class="form-control" name="country" aria-label="{% trans 'Country' %}">
            <option></option>
            {% for option in filters_data.country %}
                <option value="{{ option.key }}" {% if applied_filters.country == option.key|stringformat:'s' %}selected{% endif %}>{{ option.label }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group mb-0">
        <label class="form-label" for="collection">{% trans "Collection" %}</label>
        <select id="collection" class="form-control" name="collection" aria-label="{% trans 'Collection' %}">
            <option></option>
            {% for option in filters_data.collection %}
                <option value="{{ option.key }}" {% if applied_filters.collection == option.key|stringformat:'s' %}selected{% endif %}>{{ option.label }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="filter-group-card filter-group-card--muted filter-group-card--collapsible">
    <div class="filter-group-card__title">{% trans "Category" %}</div>

    <div class="form-group mb-3">
        <label class="form-label" for="category_level">{% trans "Category Type" %}</label>
        {% with selected_category_level=applied_filters.category_level|default:"field" %}
        <select id="category_level" class="form-control" name="category_level" aria-label="{% trans 'Category Type' %}">
            {% if not filters_data.category_level %}
                <option value="field" selected>{% trans "Field" %}</option>
            {% endif %}
            {% for option in filters_data.category_level %}
                <option value="{{ option.key }}" {% if selected_category_level == option.key|stringformat:'s' %}selected{% endif %}>{{ option.label }}</option>
            {% endfor %}
        </select>
        {% endwith %}
    </div>

    <div class="form-group mb-3">
        <label class="form-label" for="category_id">{% trans "Category" %}</label>
        <select id="category_id" class="form-control" name="category_id" aria-label="{% trans 'Category' %}">
            <option></option>
        </select>
    </div>
</div>

<div class="filter-group-card filter-group-card--muted filter-group-card--collapsible">
    <div class="filter-group-card__title">{% trans "Indexing / Coverage" %}</div>

    <div class="form-group mb-3">
        <label class="form-label" for="is_scielo">{% trans "Is SciELO" %}</label>
        <select id="is_scielo" class="form-control" name="is_scielo" aria-label="{% trans 'Is SciELO' %}">
            <option value="">{% trans "Select an option" %}</option>
            <option value="Yes" {% if applied_filters.is_scielo == "Yes" %}selected{% endif %}>{% trans "Yes" %}</option>
            <option value="No" {% if applied_filters.is_scielo == "No" %}selected{% endif %}>{% trans "No" %}</option>
        </select>
    </div>

    <div class="form-group mb-3">
        <label class="form-label" for="is_scopus">{% trans "Is Scopus" %}</label>
        <select id="is_scopus" class="form-control" name="is_scopus" aria-label="{% trans 'Is Scopus' %}">
            <option value="">{% trans "Select an option" %}</option>
            <option value="Yes" {% if applied_filters.is_scopus == "Yes" %}selected{% endif %}>{% trans "Yes" %}</option>
            <option value="No" {% if applied_filters.is_scopus == "No" %}selected{% endif %}>{% trans "No" %}</option>
        </select>
    </div>

    <div class="form-group mb-3">
        <label class="form-label" for="is_wos">{% trans "Is WoS" %}</label>
        <select id="is_wos" class="form-control" name="is_wos" aria-label="{% trans 'Is WoS' %}">
            <option value="">{% trans "Select an option" %}</option>
            <option value="Yes" {% if applied_filters.is_wos == "Yes" %}selected{% endif %}>{% trans "Yes" %}</option>
            <option value="No" {% if applied_filters.is_wos == "No" %}selected{% endif %}>{% trans "No" %}</option>
        </select>
    </div>

    <div class="form-group mb-3">
        <label class="form-label" for="is_doaj">{% trans "Is DOAJ" %}</label>
        <select id="is_doaj" class="form-control" name="is_doaj" aria-label="{% trans 'Is DOAJ' %}">
            <option value="">{% trans "Select an option" %}</option>
            <option value="Yes" {% if applied_filters.is_doaj == "Yes" %}selected{% endif %}>{% trans "Yes" %}</option>
            <option value="No" {% if applied_filters.is_doaj == "No" %}selected{% endif %}>{% trans "No" %}</option>
        </select>
    </div>

    <div class="form-group mb-3">
        <label class="form-label" for="is_openalex">{% trans "Is OpenAlex" %}</label>
        <select id="is_openalex" class="form-control" name="is_openalex" aria-label="{% trans 'Is OpenAlex' %}">
            <option value="">{% trans "Select an option" %}</option>
            <option value="Yes" {% if applied_filters.is_openalex == "Yes" %}selected{% endif %}>{% trans "Yes" %}</option>
            <option value="No" {% if applied_filters.is_openalex == "No" %}selected{% endif %}>{% trans "No" %}</option>
        </select>
    </div>

    <div class="form-group mb-0">
        <label class="form-label" for="is_journal_multilingual">{% trans "Is Multilingual" %}</label>
        <select id="is_journal_multilingual" class="form-control" name="is_journal_multilingual" aria-label="{% trans 'Is Multilingual' %}">
            <option value="">{% trans "Select an option" %}</option>
            <option value="Yes" {% if applied_filters.is_journal_multilingual == "Yes" %}selected{% endif %}>{% trans "Yes" %}</option>
            <option value="No" {% if applied_filters.is_journal_multilingual == "No" %}selected{% endif %}>{% trans "No" %}</option>
        </select>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const appliedFilters = {{ applied_filters_json|safe|default:'{}' }};
    const defaultPublicationYear = "{{ default_publication_year|default:'' }}";
    const defaultCategoryLevel = String(appliedFilters.category_level || 'field').trim().toLowerCase() || 'field';
    const anyValuePlaceholder = "{% filter escapejs %}{% trans 'Any value' %}{% endfilter %}";

    try {
        const simpleSelectFields = [
            "is_scielo",
            "is_scopus",
            "is_wos",
            "is_doaj",
            "is_openalex",
            "is_journal_multilingual",
            "limit",
        ];

        simpleSelectFields.forEach(fieldId => {
            const selectElement = document.getElementById(fieldId);
            if (!selectElement) return;
            $(selectElement).select2({
                placeholder: anyValuePlaceholder || '',
                allowClear: true,
                minimumResultsForSearch: Infinity,
                theme: 'bootstrap-5',
            }).on('select2:open', function(e) {
                document.querySelector(`[aria-controls="select2-${e.target.id}-results"]`).focus();
            });
        });
    } catch (error) {
        console.error('Error initializing Select2', error);
    }

    const publicationYearInput = document.getElementById('publication_year');
    if (publicationYearInput) {
        $(publicationYearInput).datepicker({
            format: "yyyy",
            viewMode: "years",
            minViewMode: "years",
            autoclose: true,
            startDate: '1800',
            endDate: '2100',
            container: 'body',
            orientation: 'bottom auto',
            zIndexOffset: 2000,
        });
    }

    const searchableSingleSelectFields = [
        "country",
        "collection",
        "category_level",
        "ranking_metric",
    ];

    // These placeholders are translated server-side (template render) to avoid
    // depending on the JS catalog extracting strings from inline scripts.
    const searchableSinglePlaceholders = {
        country: "{% trans 'Select a country' %}",
        collection: "{% trans 'Select a collection' %}",
        category_level: "{% trans 'Select a category type' %}",
        ranking_metric: "{% trans 'Select a ranking metric' %}",
    };

    searchableSingleSelectFields.forEach(fieldId => {
        const selectElement = document.getElementById(fieldId);
        if (!selectElement) return;

        $(selectElement).select2({
            placeholder: searchableSinglePlaceholders[fieldId] || "{% trans 'Select a value' %}",
            allowClear: fieldId !== 'category_level',
            theme: 'bootstrap-5',
        }).on('select2:open', function(e) {
            document.querySelector(`[aria-controls="select2-${e.target.id}-results"]`).focus();
        });
    });

    const categoryLevelSelect = document.getElementById('category_level');
    if (categoryLevelSelect && !String(categoryLevelSelect.value || '').trim()) {
        const hasDefaultOption = Array.from(categoryLevelSelect.options || []).some(option => option.value === defaultCategoryLevel);
        if (!hasDefaultOption) {
            categoryLevelSelect.add(new Option(defaultCategoryLevel, defaultCategoryLevel, false, false));
        }
        categoryLevelSelect.value = defaultCategoryLevel;
        if (typeof $ !== 'undefined' && $.fn && $.fn.select2) {
            $(categoryLevelSelect).trigger('change.select2');
        }
    }

    const specialSelectConfig = {
        journal_title: {
            placeholder: "{% trans 'Type journal name...' %}",
            minimumInputLength: 2,
            showDocCount: false,
        },
        journal_issn: {
            placeholder: "{% trans 'Type ISSN...' %}",
            minimumInputLength: 2,
            showDocCount: false,
        },
        publisher_name: {
            placeholder: "{% trans 'Type publisher name...' %}",
            minimumInputLength: 2,
            showDocCount: false,
        },
        category_id: {
            placeholder: "{% trans 'Select a category id' %}",
            minimumInputLength: 0,
            showDocCount: true,
        },
    };

    function formatSearchOptionText(item, showDocCount) {
        const baseLabel = item.label || item.key;
        if (!showDocCount) {
            return baseLabel;
        }

        const count = Number(item.doc_count);
        if (!Number.isFinite(count)) {
            return baseLabel;
        }
        return `${baseLabel} (${count.toLocaleString()})`;
    }

    function appendOptionIfMissing(selectElement, value, text, selected=false) {
        if (!selectElement || !value) return;
        const normalizedValue = String(value);
        const alreadyExists = Array.from(selectElement.options).some(option => option.value === normalizedValue);
        if (!alreadyExists) {
            const option = new Option(text || normalizedValue, normalizedValue, selected, selected);
            selectElement.add(option);
            return;
        }

        if (selected) {
            selectElement.value = normalizedValue;
        }
    }

    function buildSearchItemUrl(fieldId, queryTerm = '') {
        const params = new URLSearchParams({
            field_name: fieldId,
            data_source: 'journal_metrics',
            q: queryTerm || '',
        });

        if (fieldId === 'category_id') {
            const categoryLevelElement = document.getElementById('category_level');
            const categoryLevelValue = (categoryLevelElement ? categoryLevelElement.value : '') || defaultCategoryLevel;
            params.set('category_level', categoryLevelValue);
        }

        return `/search-gateway/search-item/?${params.toString()}`;
    }

    async function preloadSpecialSelectOptions(fieldId, selectedValue = null) {
        const fieldConfig = specialSelectConfig[fieldId];
        const selectElement = document.getElementById(fieldId);
        if (!fieldConfig || !selectElement) return;

        if (fieldId === 'category_id') {
            selectElement.innerHTML = '<option></option>';
        }

        try {
            const response = await fetch(buildSearchItemUrl(fieldId, ''));
            if (!response.ok) return;

            const data = await response.json();
            const results = Array.isArray(data.results) ? data.results : [];
            results.forEach(item => {
                appendOptionIfMissing(
                    selectElement,
                    item.key,
                    formatSearchOptionText(item, fieldConfig.showDocCount),
                );
            });

            if (selectedValue) {
                appendOptionIfMissing(selectElement, selectedValue, selectedValue, true);
            } else if (fieldId === 'category_id') {
                selectElement.value = '';
            }

            if (typeof $ !== 'undefined' && $.fn && $.fn.select2) {
                $(selectElement).trigger('change.select2');
            }
        } catch (error) {
            console.error(`Error preloading options for ${fieldId}`, error);
        }
    }

    Object.entries(specialSelectConfig).forEach(([fieldId, fieldConfig]) => {
        const selectElement = document.getElementById(fieldId);
        if (!selectElement) return;

        $(selectElement).select2({
            ajax: {
                url: () => '/search-gateway/search-item/',
                dataType: 'json',
                delay: 300,
                data: params => {
                    const requestParams = {
                        field_name: fieldId,
                        data_source: 'journal_metrics',
                        q: params.term || '',
                    };

                    if (fieldId === 'category_id') {
                        const categoryLevelElement = document.getElementById('category_level');
                        const categoryLevelValue = (categoryLevelElement ? categoryLevelElement.value : '') || defaultCategoryLevel;
                        requestParams.category_level = categoryLevelValue;
                    }

                    return requestParams;
                },
                processResults: data => ({
                    results: (data.results || []).map(item => ({
                        id: item.key,
                        text: formatSearchOptionText(item, fieldConfig.showDocCount),
                    })),
                }),
            },
            minimumInputLength: fieldConfig.minimumInputLength,
            placeholder: fieldConfig.placeholder || gettext('Type to search...'),
            theme: 'bootstrap-5',
            allowClear: true,
        }).on('select2:open', function(e) {
            document.querySelector(`[aria-controls="select2-${e.target.id}-results"]`).focus();
        });

        if (fieldId !== 'category_id' && appliedFilters[fieldId]) {
            appendOptionIfMissing(selectElement, appliedFilters[fieldId], appliedFilters[fieldId], true);
            $(selectElement).trigger('change');
        }
    });

    await preloadSpecialSelectOptions('category_id', appliedFilters.category_id || null);

    const categoryLevelElement = document.getElementById('category_level');
    if (categoryLevelElement) {
        categoryLevelElement.addEventListener('change', function() {
            if (!String(this.value || '').trim()) {
                this.value = defaultCategoryLevel;
                if (typeof $ !== 'undefined' && $.fn && $.fn.select2) {
                    $(this).trigger('change.select2');
                }
            }

            const categoryIdElement = document.getElementById('category_id');
            if (categoryIdElement && typeof $ !== 'undefined' && $.fn && $.fn.select2) {
                $(categoryIdElement).val(null).trigger('change');
            } else if (categoryIdElement) {
                categoryIdElement.value = '';
            }

            preloadSpecialSelectOptions('category_id');
        });
    }

    const resetButton = document.getElementById('menu-reset-journal-metrics');
    const menuForm = document.getElementById('menu-form-journal-metrics');

    if (!resetButton || !menuForm) return;

    resetButton.addEventListener('click', function(e) {
        e.preventDefault();
        const resetUrl = `${window.location.pathname}${window.location.search}`;
        window.location.assign(resetUrl);
    });
});
</script>

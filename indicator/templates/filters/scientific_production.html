{% load i18n static %}

<div class="filter-group-card filter-group-card--muted filter-group-card--collapsible mb-3">
  <div class="filter-group-card__title">{% trans "Graph Options" %}</div>
  <div class="form-group mb-0">
    <label for="breakdown_variable" class="form-label">{% trans "Breakdown Variable" %}</label>
    <select id="breakdown_variable" class="form-control" name="breakdown_variable">
      <option></option>
      <option value="scope">{% trans "Scope" %}</option>
      <option value="source_type">{% trans "Source Type" %}</option>
      <option value="document_type">{% trans "Document Type" %}</option>
      <option value="document_language">{% trans "Document Language" %}</option>
      <option value="open_access">{% trans "Open Access" %}</option>
      <option value="access_type">{% trans "Access Type" %}</option>
      <option value="subject_area_level_0">{% trans "Domain" %}</option>
      <option value="subject_area_level_1">{% trans "Field" %}</option>
      <option value="subject_area_level_2">{% trans "Subfield" %}</option>
      <option value="topic">{% trans "Topic" %}</option>
    </select>
  </div>
</div>

<h4 class="my-2 pt-1">{% trans "Filters" %}</h4>

<div class="filter-group-card filter-group-card--muted filter-group-card--collapsible">
  <div class="filter-group-card__title">{% trans "Indexing" %}</div>

  <div class="form-group mb-3">
      <label class="form-label" for="source_indexed_in">{% trans "Indexed in" %}</label>
      <select multiple id="source_indexed_in" class="form-control" name="source_indexed_in" aria-label="{% trans 'Indexed in' %}">
      </select>
  </div>

  <div class="form-group mb-3">
      <label class="form-label" for="source_type">{% trans "Source Type" %}</label>
      <select multiple id="source_type" class="form-control" name="source_type" aria-label="{% trans 'Source Type' %}">
      </select>
  </div>
</div>

<div class="filter-group-card filter-group-card--muted filter-group-card--collapsible">
  <div class="filter-group-card__title">{% trans "Source Identity" %}</div>

  <div class="form-group mb-3">
      <label class="form-label" for="source_name">{% trans "Source" %}</label>
      <div class="input-group">
          <div class="flex-grow-1 position-relative input-group-left">
              <select id="source_name" class="form-control" name="source_name" aria-label="{% trans 'Source' %}"></select>
          </div>
          <button aria-pressed="false" class="btn btn-outline input-group-right toggle-not" type="button" id="source_name_bool_not" title="{% trans 'Click to activate not operator' %}">NOT</button>
      </div>
  </div>

  <div class="form-group mb-3">
      <label class="form-label" for="publisher">{% trans "Publisher" %}</label>
      <div class="input-group">
          <div class="flex-grow-1 position-relative input-group-left">
              <select id="publisher" class="form-control" name="publisher" aria-label="{% trans 'Publisher' %}"></select>
          </div>
          <button aria-pressed="false" class="btn btn-outline input-group-right toggle-not" type="button" id="publisher_bool_not" title="{% trans 'Click to activate not operator' %}">NOT</button>
      </div>
  </div>

  <div class="form-group mb-3">
      <label class="form-label" for="source_country">{% trans "Source Country" %}</label>
      <div class="input-group">
          <div class="flex-grow-1 position-relative input-group-left">
              <select id="source_country" class="form-control" name="source_country" aria-label="{% trans 'Source Country' %}"></select>
          </div>
          <button aria-pressed="false" class="btn btn-outline input-group-right toggle-not" type="button" id="source_country_bool_not" title="{% trans 'Click to activate not operator' %}">NOT</button>
      </div>
  </div>

</div>

<div class="filter-group-card filter-group-card--muted filter-group-card--collapsible">
  <div class="filter-group-card__title">{% trans "Document Core" %}</div>

  <div class="form-group mb-3">
    <label class="form-label" for="document_publication_year_start">{% trans "Publication Year" %}</label>
    <div class="input-group">
      <input
        id="document_publication_year_start"
        name="document_publication_year_start"
        type="text"
        class="form-control is-height-2-4"
        aria-label="{% trans 'Publication Year Start' %}"
        placeholder="{% trans 'Start' %}"
        value="2019"
      />
      <input
        id="document_publication_year_end"
        name="document_publication_year_end"
        type="text"
        class="form-control is-height-2-4"
        aria-label="{% trans 'Publication Year End' %}"
        placeholder="{% trans 'End' %}"
        value="2025"
      />
    </div>
  </div>

  <div class="form-group mb-3">
      <label class="form-label" for="document_type">{% trans "Document Type" %}</label>
      <select multiple id="document_type" class="form-control" name="document_type" aria-label="{% trans 'Type' %}"></select>
  </div>

  <div class="form-group mb-3">
      <label class="form-label" for="document_language">{% trans "Document Language" %}</label>
      <div class="input-group">
          <div class="flex-grow-1 position-relative input-group-left">
              <select class="form-control" id="document_language" name="document_language" aria-label="{% trans 'Document Language' %}">
                  <option></option>
              </select>
          </div>
          <button aria-pressed="false" class="btn btn-outline input-group-right toggle-not" type="button" id="document_language_bool_not" title="{% trans 'Click to activate not operator' %}">NOT</button>
      </div>
  </div>

  <div class="form-group mb-3">
      <label class="form-label" for="open_access">{% trans "Open Access" %}</label>
      <select id="open_access" class="form-control" name="open_access" aria-label="{% trans 'Open Access' %}">
          <option></option>
          <option value="Yes">Yes</option>
          <option value="No">No</option>
      </select>
  </div>

  <div class="form-group mb-3">
      <label class="form-label" for="open_access_status">{% trans "Access Type" %}</label>
      <select multiple id="open_access_status" class="form-control" name="open_access_status" aria-label="{% trans 'Access Type' %}">
      </select>
  </div>
</div>

<div class="filter-group-card filter-group-card--muted filter-group-card--collapsible">
  <div class="filter-group-card__title">{% trans "Category" %}</div>

  <div class="form-group mb-3">
      <label class="form-label" for="subject_area_level_0">{% trans "Domain" %}</label>
      <select multiple id="subject_area_level_0" class="form-control" name="subject_area_level_0" aria-label="{% trans 'Domain' %}">
      </select>
  </div>

  <div class="form-group mb-3">
      <label class="form-label" for="subject_area_level_1">{% trans "Field" %}</label>
      <select multiple id="subject_area_level_1" class="form-control" name="subject_area_level_1" aria-label="{% trans 'Field' %}">
      </select>
  </div>

  <div class="form-group mb-3">
      <label class="form-label" for="subject_area_level_2">{% trans "Subfield" %}</label>
      <select multiple id="subject_area_level_2" class="form-control" name="subject_area_level_2" aria-label="{% trans 'Subfield' %}">
      </select>
  </div>
</div>

<div class="filter-group-card filter-group-card--muted filter-group-card--collapsible">
  <div class="filter-group-card__title">{% trans "Funding" %}</div>

  <div class="form-group mb-0">
    <label class="form-label" for="funder">{% trans "Funder" %}</label>
    <div class="input-group">
        <div class="flex-grow-1 position-relative input-group-left">
            <select id="funder" class="form-control" name="funder" aria-label="{% trans 'Funder' %}"></select>
        </div>
        <button aria-pressed="false" class="btn btn-outline input-group-right toggle-not" type="button" id="funder_bool_not" title="{% trans 'Click to activate not operator' %}">NOT</button>
    </div>
  </div>
</div>

<div class="filter-group-card filter-group-card--muted filter-group-card--collapsible">
  <div class="filter-group-card__title">{% trans "Author Affiliation" %}</div>

  <div class="form-group mb-3">
      <label class="form-label" for="institution">{% trans "Institution" %}</label>
      <select multiple id="institution" class="form-control" name="institution" aria-label="{% trans 'Institution' %}">
      </select>
  </div>

  <div class="form-group mb-0">
      <label class="form-label" for="country">{% trans "Country" %}</label>
      <div class="d-flex align-items-start justify-content-between">
          <div class="select-left flex-grow-1">
              <select multiple id="country" name="country" class="form-control" aria-label="{% trans 'Country' %}"></select>
          </div>
          <div class="select-right">
              <select id="country_operator" name="country_operator" class="form-control" aria-label="{% trans 'Country Query Operator' %}">
                  <option value="and" selected>AND</option>
                  <option value="or">OR</option>
              </select>
          </div>
      </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const currentDataSource = "{{ data_source|default:'scientific'|escapejs }}";
    const currentQueryParams = new URLSearchParams(window.location.search);
    const selectedScope = (currentQueryParams.get('scope') || '').trim();
    const filterParams = selectedScope ? { scope: selectedScope } : {};

    const ph = {
        breakdown_variable: "{% filter escapejs %}{% trans 'Select a breakdown variable' %}{% endfilter %}",
        document_language: "{% filter escapejs %}{% trans 'Select a language' %}{% endfilter %}",
        open_access: "{% filter escapejs %}{% trans 'Select an open access status' %}{% endfilter %}",
        open_access_status: "{% filter escapejs %}{% trans 'Select an access type' %}{% endfilter %}",
        country: "{% filter escapejs %}{% trans 'Search for a country' %}{% endfilter %}",
        document_type: "{% filter escapejs %}{% trans 'Select a document type' %}{% endfilter %}",
        source_indexed_in: "{% filter escapejs %}{% trans 'Select source indexes' %}{% endfilter %}",
        source_type: "{% filter escapejs %}{% trans 'Select a source type' %}{% endfilter %}",
        subject_area_level_0: "{% filter escapejs %}{% trans 'Select a domain' %}{% endfilter %}",
        subject_area_level_1: "{% filter escapejs %}{% trans 'Select a field' %}{% endfilter %}",
        subject_area_level_2: "{% filter escapejs %}{% trans 'Select a subfield' %}{% endfilter %}",
        subject_area_level_3: "{% filter escapejs %}{% trans 'Select a topic' %}{% endfilter %}",
        topic: "{% filter escapejs %}{% trans 'Select a topic' %}{% endfilter %}",
        institution: "{% filter escapejs %}{% trans 'Search for an institution' %}{% endfilter %}",
        funder: "{% filter escapejs %}{% trans 'Search for a funder' %}{% endfilter %}",
        publisher: "{% filter escapejs %}{% trans 'Search for a publisher' %}{% endfilter %}",
        source_country: "{% filter escapejs %}{% trans 'Search for a country' %}{% endfilter %}",
        source_name: "{% filter escapejs %}{% trans 'Search for a primary source (journal, book, conference, etc.)' %}{% endfilter %}",
    };

    // Populate filters
    try {
        const data = await fetchFilters(currentDataSource, filterParams);
        populateSelectFilters(
            // Filters data retrieved from the index API
            data,
            // Fields that we don't want to populate because they are handled differently
            [
              'breakdown_variable',
              'country_operator',
              'document_publication_year_end',
              'document_publication_year_start',
              'funder',
              'institution',
              'open_access',
              'publisher',
              'source_country',
              'source_name',
            ]
        );
    } catch (error) {
        console.error('Error loading filters', error);
    }

    // Initialize datepicker fields
    const yearFields = [
        'document_publication_year_start',
        'document_publication_year_end',
    ];
    yearFields.forEach(fieldId => {
        setupDatePicker(fieldId);
    });

    // Initialize singleselect fields
    const singleSelectFieldsOpts = [
        ["country_operator", "", false, false],
        ['breakdown_variable', ph.breakdown_variable, false, true],
        ['document_language', ph.document_language, true, true],
        ['open_access', ph.open_access, false, true],
    ];
    singleSelectFieldsOpts.forEach(([fieldId, fieldPlaceholder, allowSearch, allowClear]) => {
        setupSelect2Single(fieldId, fieldPlaceholder, allowSearch, allowClear);
    });

    // Initialize multiselect fields
    const multiSelectFieldsOpts = [
        ['open_access_status', ph.open_access_status, false],
        ["country", ph.country, false],
        ['document_type', ph.document_type, false],
        ['source_indexed_in', ph.source_indexed_in, false],
        ['source_type', ph.source_type, false],
        ['subject_area_level_0', ph.subject_area_level_0, false],
        ['subject_area_level_1', ph.subject_area_level_1, false],
        ['subject_area_level_2', ph.subject_area_level_2, false],
    ];
    multiSelectFieldsOpts.forEach(([fieldId, fieldPlaceholder, allowClear]) => {
        setupSelect2Multiple(fieldId, fieldPlaceholder, allowClear);
    });

    // Initialize SearchAsYouType fields
    const saytFieldsOpts = [
            ['institution', currentDataSource, ph.institution, true],
            ['funder', currentDataSource, ph.funder, true],
            ['publisher', currentDataSource, ph.publisher, true],
            ['source_country', currentDataSource, ph.source_country, true],
            ['source_name', currentDataSource, ph.source_name, true],
    ];
    saytFieldsOpts.forEach(([fieldId, fieldDataSource, fieldPlaceholder, allowClear]) => {
        setupSelect2SearchAsYouType(fieldId, fieldDataSource, fieldPlaceholder, allowClear);
    });

    document.dispatchEvent(new CustomEvent('indicator:filters-ready', {
        detail: { dataSource: currentDataSource }
    }));
});
</script>
